# This workflow validates, deploys, and runs the specified bundle
# within a QA target named "qa".
name: 'QA Deployment'
run-name: {% raw %}${{ github.actor }}{% endraw %} deployed to QA ðŸ§ª

# Ensure that only a single job or workflow using the same concurrency group
# runs at a time.
concurrency: 1

# Trigger this workflow whenever a push is made to the qa branch.
on:
  push:
    branches:
      - qa

permissions:
  id-token: write
  contents: read

env:
  DATABRICKS_BUNDLE_ENV: qa
  DATABRICKS_AUTH_TYPE: github-oidc
  DATABRICKS_HOST: {{ cookiecutter.databricks_qa_host }}/
  DATABRICKS_CLIENT_ID: {{ cookiecutter.qa_service_principal_id }}

jobs:
  deploy:
    name: 'Deploy bundle'
    runs-on: ubuntu-latest
    environment: qa

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        uses: databricks/setup-cli@main

      - name: Validate Bundle Before Deployment
        id: validate
        run: databricks bundle validate --target qa

      - name: Deploy Bundle To Workspace
        run: databricks bundle deploy --target qa
